name: Cypress E2E Tests

on:
  push:
    branches: [ main ]
  pull_request: 
    types: [opened, synchronize]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'
        cache: 'npm'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # # This creates a cache key. ‘hashFiles’ generates SHA256 hash of ‘package-lock.json ‘ file in the repository. We create this key to ensure that if the package-lock.json file is changed, a new cache will be created.
    # - name: Restore cached dependencies 
    #   id: cache-restore 
    #   uses: actions/cache@v3 
    #   with: 
    #     # If node_modules is inside src, modify it to ./src/node_modules
    #     path: ./node_modules 
    #     key: npm-${{ hashFiles('./package-lock.json') }} 

    - name: Install Node.js dependencies 
      # This IF condition checks if the step with id ‘cache-restore’ was successful in finding the cache or not. If successful, it will skip npm ci step otherwise execute it.
      # if: steps.cache-restore.outputs.cache-hit != 'true' 
      # If node_modules is inside src, add command below cd src
      run: | 
        npm ci - ignore-scripts 

    - name: Run Django migrations
      run: |
        python manage.py migrate --noinput

    # - name: Collect static files
    #   run: |
    #     python manage.py collectstatic --noinput

    # - name: Build frontend assets
    #   run: |
    #     npm run build

    - name: Start Django server
      run: |
        python manage.py runserver 127.0.0.1:8000 &
        echo $! > django.pid
      env:
        DJANGO_SETTINGS_MODULE: formula1charts.settings

    - name: Start frontend development server
      run: |
        npm run start &
        echo $! > webpack.pid

    - name: Wait for servers to be ready
      run: |
        echo "Waiting for Django server..."
        timeout 60 bash -c 'until curl -f http://127.0.0.1:8000; do sleep 2; done'
        echo "Django server is ready!"
        
        echo "Waiting for webpack to compile..."
        sleep 30

    - name: Run Cypress tests
      uses: cypress-io/github-action@v6
      with:
        working-directory: ./
        wait-on: 'http://127.0.0.1:8000'
        wait-on-timeout: 120
        browser: chrome
        spec: cypress/e2e/test_pages.cy.js
      env:
        CYPRESS_baseUrl: http://127.0.0.1:8000

    - name: Trigger Vercel Deploy
      run: |
        curl -X POST https://api.vercel.com/v1/integrations/deploy/${{secrets.VERCEL_DEPLOY_HOOK}}

    - name: Cleanup processes
      if: always()
      run: |
        if [ -f django.pid ]; then
          kill $(cat django.pid) || true
          rm django.pid
        fi
        if [ -f webpack.pid ]; then
          kill $(cat webpack.pid) || true
          rm webpack.pid
        fi
        # Kill any remaining processes
        pkill -f "manage.py runserver" || true
        pkill -f "webpack" || true